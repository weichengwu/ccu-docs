# 启动流程

建议使用一个类管理这个过程，并且一台主机对应一个类的实例。

## 1. 发现局域网内的主机

客户端启动时需要知道当前局域网内有哪些主机。

> [!TIP]
> 由于主机的 IP 地址是不固定的，不同用户家里的主机也是不一样的，所以这些信息不推荐提前录入，也不推荐缓存。

逻辑：

1. 开启一个 UDP Socket
2. 向 `255.255.255.255:8989` 发送「发现主机」请求报文
3. 监听广播的数据，当接收到的数据中包含「发现主机」的响应报文时开始解析其内容
4. 关闭 UDP Socket

参考：

* [中控发现链路](../quick-start/network)
* [发现主机](../api/ccu)

## 2. 连接主机

发现到主机之后，用户手动选择其中一台主机，即可开始建立 TCP 连接，连接所需要的参数均从发现主机的结果中获取。

与主机建立连接成功之后即可与主机进行通讯，不过需要发送的第一条报文是「登录主机」，否则没有认证通过 10 秒内主机将自动与客户端断开连接。

逻辑：

1. 开启一个 TCP Socket
2. 与中控主机的 IP 建立连接，如果中控主机支持 SSL，则端口为 5001，否则使用 5000。

参考：

* [中控服务链路](../quick-start/network)

## 3. 登录主机

登录成功之后即获得主机的认证，即可与主机进行正常的数据通信。

参考：

* [登录主机](../api/ccu)

## 4. 主机心跳

为防止长时间没有报文产生，主机认为客户端离线从而主动与客户端断开连接，还需要定时向主机发送心跳报文。

> [!TIP]
> 建议心跳的间隔为 30 秒。

参考：

* [交互协议/主机心跳](../api/ccu)

## 5. 同步数据

此步骤将获取到主机内的所有数据。

> [!TIP]
> * 每一次主动向主机同步数据之后，主机会主动向客户端推送一条新设备报文。
> * 同步数据和新设备数据建议以数据库的形式缓存到磁盘，设备状态发生变化时，中控会向客户端推送消息，此时修改数据库，从而保持客户端在运行期间数据永远是准确的，下次客户端启动时再重新执行一遍同步数据，全盘覆盖当前主机内的数据。

参考：

* [同步数据](../api/ccu)

## 6. 处理新设备

每次执行同步数据的操作后，中控主机会向客户端推送新设备，此时需要解析处理新设备。

参考：

* [新设备数据](../api/ccu)

## 7. 通知上层 UI 刷新

主机内数据都获取完毕且已缓存好之后，通知上层 UI，此时上层 UI 可以从本地数据库查询任何信息。

当主机内的数据发生变更时，会通过对应的报文通知到客户端，客户端需要做的就是持续解析主机发送过来的数据，并且修改数据库，通知上层 UI 刷新。